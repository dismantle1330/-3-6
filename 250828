import React, { useMemo, useState } from "react";
import { motion, AnimatePresence } from "framer-motion";
import { Check, AlertCircle, Clock, ChevronRight, ChevronDown, Mail, Building2, FileText, Users, ExternalLink, TriangleAlert } from "lucide-react";
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Input } from "@/components/ui/input";
import { Textarea } from "@/components/ui/textarea";

// ğŸ§­ èªªæ˜ï¼š
// é€™æ˜¯ä¸€å€‹å–®æª” React é é¢ï¼ˆå¯ç›´æ¥æ”¾åœ¨ Next.js / Vite å°ˆæ¡ˆä¸­ï¼‰ã€‚
// - å·¦å´ï¼šå°ˆæ¡ˆèˆ‡é …ç›®æ¸…å–® + é—œéµç¯©é¸
// - å³å´ï¼šé»é¸é …ç›®å¾Œé¡¯ç¤ºã€Œç›®å‰ç‹€æ…‹ã€å·²ç¢ºèªå–®ä½ã€èªªæ˜ã€æ™‚ç¨‹æµå‘åœ–ã€
// - å…§å»ºè¼•é‡ç·¨è¼¯ï¼ˆåƒ…åœ¨å‰ç«¯ç‹€æ…‹ï¼Œä¸å«å¾Œç«¯å„²å­˜ï¼‰
// - 114 å¹´çš„æ—¥æœŸé¡¯ç¤ºåŒæ™‚æä¾›æ°‘åœ‹/è¥¿å…ƒå°ç…§ï¼ˆç°¡æ˜“æ›ç®—ï¼‰
// - å¯ä¾éœ€æ±‚æ¥ API / ä¸²æ¥è¡¨å–®

// ====== å‹åˆ¥èˆ‡å·¥å…· ======
const STATUS_OPTIONS = [
  { key: "todo", label: "å¾…è™•ç†", icon: Clock },
  { key: "in_progress", label: "è™•ç†ä¸­", icon: TriangleAlert },
  { key: "waiting_ext", label: "å¾…å°æ–¹å›è¦†", icon: Mail },
  { key: "review", label: "å…§éƒ¨å¯©æ ¸ä¸­", icon: FileText },
  { key: "done", label: "å·²å®Œæˆ", icon: Check },
] as const;

type StatusKey = typeof STATUS_OPTIONS[number]["key"];

type StepKey = "èµ·æ¡ˆ" | "è‰æ“¬" | "å…§éƒ¨å¯©æ ¸" | "å°å¤–æºé€š" | "å¾…å›è¦†/åŸ·è¡Œ" | "å®Œæˆ";

function statusToStep(status: StatusKey): StepKey {
  switch (status) {
    case "todo":
      return "èµ·æ¡ˆ";
    case "in_progress":
      return "å°å¤–æºé€š";
    case "waiting_ext":
      return "å¾…å›è¦†/åŸ·è¡Œ";
    case "review":
      return "å…§éƒ¨å¯©æ ¸";
    case "done":
      return "å®Œæˆ";
    default:
      return "èµ·æ¡ˆ";
  }
}

function rocToGreg(roc: string | null | undefined) {
  // æœŸå¾…æ ¼å¼ï¼š1140926 / 1140831 ä¹‹é¡ï¼›å›å‚³ { roc: '1140926', greg: '2025-09-26' }
  if (!roc) return null;
  const m = String(roc).match(/^(\d{3})(\d{2})(\d{2})$/);
  if (!m) return { roc, greg: "æ ¼å¼ä¸ç¬¦" } as any;
  const year = 1911 + parseInt(m[1], 10);
  const month = parseInt(m[2], 10);
  const day = parseInt(m[3], 10);
  const mm = month.toString().padStart(2, "0");
  const dd = day.toString().padStart(2, "0");
  return { roc, greg: `${year}-${mm}-${dd}` };
}

// ====== åˆå§‹è³‡æ–™ï¼ˆä¾ä½¿ç”¨è€…æä¾›ï¼‰ ======
const INITIAL_DATA = {
  projects: [
    {
      id: "xinshui1",
      name: "æ–°æ°´1",
      items: [
        {
          id: "xs1-1",
          title: "ä¹…ç¦¾ FeMS è«‹æ¬¾å–®",
          status: "waiting_ext" as StatusKey,
          owners: ["æ­é™½å…ˆç”Ÿ", "ä¹…ç¦¾"],
          confirmedBy: [],
          dueRoc: null,
          note:
            "å°æ–¹å¾ˆå¿™ï¼Œå¯èƒ½æ˜ŸæœŸäº”æˆ–ä¸‹é€±æ‰æœƒå‚³ï¼›è‹¥æœªå‚³å†æé†’ã€‚",
          evidenceLinks: [],
        },
        {
          id: "xs1-2",
          title: "ç§Ÿèˆ¹ç›¸é—œæ–‡ä»¶",
          status: "in_progress" as StatusKey,
          owners: ["å„ä¸­å¿ƒ", "ä¸»è¨ˆ"],
          confirmedBy: ["è‰æ“¬å®Œæˆï¼ˆå…§éƒ¨ï¼‰"],
          dueRoc: null,
          note:
            "æ–‡ä»¶å·²è‰æ“¬ï¼Œå…ˆçµ¦å„ä¸­å¿ƒé è¦½ä¸¦é å‚™æä¾›è³‡æ–™ï¼›å·²è©¢å•ä¸»è¨ˆï¼Œä¸»è¨ˆè¡¨ç¤ºå¾…æ–‡ç°½å‡ºä¾†å¾Œå†çµ¦æ„è¦‹ã€‚",
          evidenceLinks: [],
        },
        {
          id: "xs1-3",
          title: "åƒåœ¾è™•ç†è¨ˆç•« + èƒ½æºï¼ˆIAPP/IEE ç›¸é—œï¼‰",
          status: "waiting_ext" as StatusKey,
          owners: ["å°ˆç®¡", "ç›£é€ ", "èˆ¹å» ", "æ­é™½å…ˆç”Ÿ"],
          confirmedBy: ["å·²ç™¼ e-mail å‘ŠçŸ¥èˆ¹å» "],
          dueRoc: "1140926",
          note:
            "å”å•†æ˜¯å¦å¯ç”±å°ˆç®¡/ç›£é€ é è·ç¢ºèªè¨­å‚™ä½ç½®å¾Œä»£æ“¬ä¾›èˆ¹å» æ ¸ï¼›å°æ–¹å›è¦†ä»ä»¥ 114/09/26 æäº¤ç‚ºæº–ã€‚",
          evidenceLinks: [
            { label: "å°èˆ¹å» èªªæ˜ä¿¡ï¼ˆe-mailï¼‰", href: "#" },
          ],
        },
      ],
    },
    {
      id: "shui3",
      name: "æ°´3",
      items: [
        {
          id: "s3-1",
          title: "æ°´ä¸‰ä¿å›ºé †å»¶",
          status: "review" as StatusKey,
          owners: ["ç§˜æ›¸å®¤"],
          confirmedBy: ["æ°´3 ä¾¿ç°½å·²å®Œæˆ"],
          dueRoc: null,
          note: "å·²é€ç§˜æ›¸å®¤å¯©é–±ï¼Œä¾¿ç°½å®Œæˆã€‚",
          evidenceLinks: [],
        },
      ],
    },
    {
      id: "shui6",
      name: "æ°´6",
      items: [
        {
          id: "s6-1",
          title: "æ—å“¡é›»å­éƒµä»¶é¨·æ“¾çŸ¥æ´‹ï¼ˆå…¬æ–‡/ç°½ï¼‰",
          status: "review" as StatusKey,
          owners: ["æ—å“¡"],
          confirmedBy: [],
          dueRoc: null,
          note: "å¾…æ—å“¡æ˜æ—¥ç°½æ ¸ã€‚",
          evidenceLinks: [],
        },
        {
          id: "s6-2",
          title: "æ°´6 ä¿é¤Šè¨­å‚™ï¼ˆæ€¥è¾¦ï¼‰",
          status: "in_progress" as StatusKey,
          owners: ["æ°´6 èˆ¹å“¡", "æ°´3 è¼ªæ©Ÿ"],
          confirmedBy: ["æ–‡å­˜å®Œæˆ", "å·²ç™¼ e-mail é€šçŸ¥ç«‹å³ä¿é¤Š"],
          dueRoc: null,
          note: "æ°´3 è¼ªæ©Ÿéœ€ç†Ÿè®€æ‰‹å†Šå¾ŒåŸ·è¡Œä¿é¤Šã€‚",
          evidenceLinks: [
            { label: "é€šçŸ¥ e-mail", href: "#" },
            { label: "ä¿é¤Šæ‰‹å†Šï¼ˆå…§éƒ¨ï¼‰", href: "#" },
          ],
        },
        {
          id: "s6-3a",
          title: "æ°´6 ä¿å›º 1â€“52 é …ï¼ˆå°ˆç®¡è¦æ±‚è£œä»¶ï¼‰",
          status: "review" as StatusKey,
          owners: ["ç§˜æ›¸å®¤", "æ±éƒ¨"],
          confirmedBy: ["æ±éƒ¨æœƒè­°å·²å®Œæˆ"],
          dueRoc: "1140831",
          note:
            "å°ˆç®¡ä¾†å‡½æŒ‡æˆ‘å€‘æä¾›è³‡æ–™ä¸è¶³ï¼›ç›®å‰å…¬æ–‡åœ¨ç§˜æ›¸å®¤ã€‚å› æ±éƒ¨å¸¸éºå¤±æ–‡ä»¶ï¼Œå·²å¦è¡Œ e-mail è«‹æ±éƒ¨æä¾› 26 é …ä¾æ“šï¼Œä¸¦è«‹æ–¼ 114/08/31 å‰å›è¦†ã€‚",
          evidenceLinks: [
            { label: "å°ˆç®¡ä¾†å‡½", href: "#" },
            { label: "è‡´æ±éƒ¨å‚¬è¾¦ e-mail", href: "#" },
          ],
        },
        {
          id: "s6-3b",
          title: "å‚¬èˆ¹å» æä¾› 53â€“98 é …ä¿å›ºèªå®š",
          status: "review" as StatusKey,
          owners: ["å‰¯åº§", "ä¸»ç§˜", "è¨Šæ‹“", "èˆ¹å» "],
          confirmedBy: ["å·²ä»¥ e-mail å‚¬è¾¦"],
          dueRoc: null,
          note:
            "ç›®å‰æ–‡ä»¶è‡³å‰¯åº§ï¼Œå›é–±ä¸»ç§˜ï¼›ä¸¦å·²å‘è¨Šæ‹“åŠèˆ¹å» å‚¬ä¿ƒæäº¤çµ±æ•´ã€‚",
          evidenceLinks: [
            { label: "å‚¬è¾¦ e-mailï¼ˆå°èˆ¹å» /è¨Šæ‹“ï¼‰", href: "#" },
          ],
        },
      ],
    },
  ],
};

// ====== UI å­å…ƒä»¶ ======
const StatusBadge: React.FC<{ status: StatusKey }> = ({ status }) => {
  const def = STATUS_OPTIONS.find((s) => s.key === status)!;
  const Icon = def.icon;
  const tone = {
    todo: "bg-gray-100 text-gray-700",
    in_progress: "bg-amber-100 text-amber-800",
    waiting_ext: "bg-blue-100 text-blue-800",
    review: "bg-purple-100 text-purple-800",
    done: "bg-emerald-100 text-emerald-800",
  }[status];
  return (
    <span className={`inline-flex items-center gap-1 px-2 py-1 text-xs rounded-full ${tone}`}>
      <Icon className="h-3.5 w-3.5" /> {def.label}
    </span>
  );
};

const FlowViz: React.FC<{ current: StepKey }> = ({ current }) => {
  const steps: StepKey[] = ["èµ·æ¡ˆ", "è‰æ“¬", "å…§éƒ¨å¯©æ ¸", "å°å¤–æºé€š", "å¾…å›è¦†/åŸ·è¡Œ", "å®Œæˆ"];
  const idx = steps.indexOf(current);
  return (
    <div className="w-full">
      <div className="flex items-center justify-between gap-2">
        {steps.map((s, i) => (
          <div key={s} className="flex-1">
            <div className={`h-2 rounded-full ${i <= idx ? "bg-emerald-500" : "bg-gray-200"}`}></div>
            <div className="mt-2 flex items-center gap-2">
              <div className={`h-6 w-6 rounded-full flex items-center justify-center text-white ${i <= idx ? "bg-emerald-500" : "bg-gray-300"}`}>
                {i < idx ? <Check className="h-4 w-4" /> : i === idx ? <Clock className="h-4 w-4" /> : <></>}
              </div>
              <span className={`text-sm ${i === idx ? "font-semibold" : "text-gray-600"}`}>{s}</span>
            </div>
          </div>
        ))}
      </div>
    </div>
  );
};

const ItemCard: React.FC<{
  projectName: string;
  item: any;
  onUpdate: (patch: Partial<any>) => void;
}> = ({ projectName, item, onUpdate }) => {
  const [open, setOpen] = useState(true);
  const step = statusToStep(item.status as StatusKey);
  const due = rocToGreg(item.dueRoc);

  return (
    <Card className="shadow-sm border border-gray-200">
      <CardHeader className="pb-3">
        <div className="flex items-start justify-between gap-4">
          <div>
            <CardTitle className="text-base font-semibold leading-6 flex items-center gap-2">
              <span className="px-2 py-1 text-xs rounded-md bg-gray-50">{projectName}</span>
              {item.title}
            </CardTitle>
            <div className="mt-2 flex flex-wrap items-center gap-2">
              <StatusBadge status={item.status} />
              {due && (
                <Badge variant="secondary" className="bg-gray-100">åˆ°æœŸï¼šæ°‘åœ‹ {due.roc}ï¼ˆè¥¿å…ƒ {due.greg}ï¼‰</Badge>
              )}
              {item.confirmedBy?.map((c: string, i: number) => (
                <Badge key={i} variant="outline" className="border-emerald-300 text-emerald-700">å·²ç¢ºèªï¼š{c}</Badge>
              ))}
            </div>
          </div>
          <Button variant="ghost" className="h-8 px-2" onClick={() => setOpen(!open)}>
            {open ? <ChevronDown className="h-4 w-4" /> : <ChevronRight className="h-4 w-4" />}
          </Button>
        </div>
      </CardHeader>
      <AnimatePresence initial={false}>
        {open && (
          <motion.div initial={{ height: 0, opacity: 0 }} animate={{ height: "auto", opacity: 1 }} exit={{ height: 0, opacity: 0 }}>
            <CardContent className="pt-0">
              <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div className="md:col-span-2 space-y-4">
                  <div>
                    <div className="text-sm text-gray-500 mb-1">èªªæ˜</div>
                    <Textarea
                      value={item.note}
                      onChange={(e) => onUpdate({ note: e.target.value })}
                      className="min-h-[88px]"
                    />
                  </div>

                  <div className="flex flex-wrap items-center gap-2">
                    <div className="text-sm text-gray-500">è² è²¬/ç›¸é—œå–®ä½ï¼š</div>
                    {item.owners?.map((o: string, i: number) => (
                      <Badge key={i} className="bg-sky-50 text-sky-800 border border-sky-200" variant="outline"><Building2 className="h-3 w-3 mr-1" />{o}</Badge>
                    ))}
                  </div>

                  <div className="flex flex-wrap items-center gap-2">
                    <div className="text-sm text-gray-500">ä½è­‰/é™„ä»¶ï¼š</div>
                    {item.evidenceLinks?.length ? (
                      item.evidenceLinks.map((l: any, i: number) => (
                        <a key={i} href={l.href} className="inline-flex items-center gap-1 text-sm underline hover:no-underline">
                          {l.label} <ExternalLink className="h-3.5 w-3.5" />
                        </a>
                      ))
                    ) : (
                      <span className="text-sm text-gray-400">â€”</span>
                    )}
                  </div>
                </div>

                <div className="space-y-3">
                  <div>
                    <div className="text-sm text-gray-500 mb-1">ç›®å‰éšæ®µ</div>
                    <FlowViz current={step} />
                  </div>

                  <div className="space-y-2">
                    <div className="text-sm text-gray-500">å¿«é€Ÿæ›´æ–°</div>
                    <div className="flex flex-wrap gap-2">
                      {STATUS_OPTIONS.map((opt) => (
                        <Button key={opt.key} variant={item.status === opt.key ? "default" : "outline"} size="sm" onClick={() => onUpdate({ status: opt.key })}>
                          <opt.icon className="h-3.5 w-3.5 mr-1" /> {opt.label}
                        </Button>
                      ))}
                    </div>
                    <div className="flex items-center gap-2">
                      <Input
                        placeholder="æ°‘åœ‹æ—¥æœŸï¼ˆå¦‚ 1140926ï¼‰"
                        value={item.dueRoc ?? ""}
                        onChange={(e) => onUpdate({ dueRoc: e.target.value || null })}
                      />
                      <Badge variant="secondary">è‡ªå‹•æ›ç®—è¥¿å…ƒ</Badge>
                    </div>
                  </div>
                </div>
              </div>
            </CardContent>
          </motion.div>
        )}
      </AnimatePresence>
    </Card>
  );
};

// ====== ä¸»é é¢ ======
export default function Dashboard() {
  const [query, setQuery] = useState("");
  const [data, setData] = useState(INITIAL_DATA);
  const allItems = useMemo(() => data.projects.flatMap((p: any) => p.items.map((it: any) => ({ ...it, projectId: p.id, projectName: p.name }))), [data]);

  const filtered = useMemo(() => {
    if (!query.trim()) return allItems;
    return allItems.filter((it: any) =>
      [it.title, it.projectName, it.note, ...(it.owners || []), ...(it.confirmedBy || [])]
        .join("\n")
        .toLowerCase()
        .includes(query.toLowerCase())
    );
  }, [allItems, query]);

  function patchItem(id: string, patch: Partial<any>) {
    setData((prev: any) => ({
      projects: prev.projects.map((p: any) => ({
        ...p,
        items: p.items.map((it: any) => (it.id === id ? { ...it, ...patch } : it)),
      })),
    }));
  }

  return (
    <div className="p-6 md:p-10 max-w-6xl mx-auto">
      <div className="mb-6">
        <h1 className="text-2xl md:text-3xl font-bold tracking-tight">å°ˆæ¡ˆå„€è¡¨æ¿ï½œæ–°æ°´1ãƒ»æ°´3ãƒ»æ°´6</h1>
        <p className="text-sm text-gray-600 mt-2">é»é¸ä»»ä¸€é …ç›®å¯æŸ¥çœ‹ã€Œç›®å‰ç‹€æ…‹ã€å·²ç¢ºèªå–®ä½ã€èªªæ˜ã€é™„ä»¶ã€ï¼›å³å´é¡¯ç¤ºé€²åº¦æµå‘ï¼ˆèµ·æ¡ˆâ†’å®Œæˆï¼‰ã€‚æ­¤é åƒ…ç‚ºå‰ç«¯å±•ç¤ºï¼Œå¯æ—¥å¾Œæ¥å¾Œç«¯æˆ–åŒ¯å‡ºå ±è¡¨ã€‚</p>
      </div>

      <div className="mb-4 flex items-center gap-3">
        <Input value={query} onChange={(e) => setQuery(e.target.value)} placeholder="æœå°‹ï¼šè¼¸å…¥é—œéµå­—ã€å–®ä½ã€é¡¹ç›®åç¨±â€¦" />
        <Badge variant="outline" className="text-gray-700">ç›®å‰å…± {filtered.length} é …</Badge>
      </div>

      <div className="grid grid-cols-1 gap-4">
        {filtered.map((it: any) => (
          <ItemCard
            key={it.id}
            projectName={it.projectName}
            item={it}
            onUpdate={(patch) => patchItem(it.id, patch)}
          />
        ))}
      </div>

      <footer className="mt-10 text-xs text-gray-500">
        æç¤ºï¼šæ°‘åœ‹â†’è¥¿å…ƒåƒ…ç‚ºç°¡æ˜“æ›ç®—ï¼ˆ+1911ï¼‰ã€‚å¯¦éš›æˆªæ­¢æ—¥ä»ä»¥æ­£å¼æ–‡ç°½ç‚ºæº–ã€‚
      </footer>
    </div>
  );
}
